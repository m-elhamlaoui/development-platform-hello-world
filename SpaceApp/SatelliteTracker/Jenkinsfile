pipeline {
  agent any

  environment {
    IMAGE_NAME = 'youssefbouraoui1/django-service'
    DOCKERHUB_USER = 'youssefbouraoui1'
    SERVICES = 'django-service'
    KUBECONFIG_PATH = '/var/lib/jenkins/.kube/config'  // <- Adapté à MicroK8s
  }

  stages {
    stage('Build & Push Images') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-creds', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_TOKEN')]) {
          script {
            def tag = "build-${env.BUILD_NUMBER}"
            def image = "${DOCKERHUB_USER}/django-service:${tag}"

            sh "echo $DOCKERHUB_TOKEN | docker login -u $DOCKERHUB_USER --password-stdin"
            dir('SpaceApp/SatelliteTracker') {
              echo "🔨 Building backend Docker image: ${image}"
              sh "docker build -t ${image} ."
              sh "docker push ${image}"
            }
            sh "docker logout"
          }
        }
      }
    }

    stage('Deploy to MicroK8s') {
      steps {
        script {
          def tag = "build-${env.BUILD_NUMBER}"
          def servicesList = SERVICES.split()
          def kubeconfig = "KUBECONFIG=${KUBECONFIG_PATH}"

          // Apply deployment and service YAMLs
          sh "${kubeconfig} kubectl apply -f SpaceApp/SatelliteTracker/deployTomicrok8s.yml"
          sh "${kubeconfig} kubectl apply -f SpaceApp/SatelliteTracker/exposeService.yml"

          for (svc in servicesList) {
            def image = "${DOCKERHUB_USER}/${svc}:${tag}"
            echo "🔄 Updating deployment ${svc} with image ${image}"
            sh "${kubeconfig} kubectl set image deployment/${svc} ${svc}=${image} || true"
          }
        }
      }
    }
  }

  post {
    success {
      echo '✅ Backend image built and deployed successfully!'
    }
    failure {
      echo '❌ Backend image build or deploy failed!'
    }
  }
}